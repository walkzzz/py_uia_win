# rf-win - Windows桌面自动化Robot Framework库 正式开发文档

**文档版本**：V1.0
**修订日期**：2025-12-18
**适用范围**：rf-win库的开发、测试、维护与使用
**作者**：rf-win开发团队

## 目录

1. [文档说明](#1-文档说明)
2. [项目概述](#2-项目概述)
3. [整体架构设计](#3-整体架构设计)
4. [核心功能模块详细设计](#4-核心功能模块详细设计)
5. [兼容性与适配策略](#5-兼容性与适配策略)
6. [易用性设计](#6-易用性设计)
7. [性能与稳定性优化](#7-性能与稳定性优化)
8. [测试体系](#8-测试体系)
9. [文档与生态建设](#9-文档与生态建设)
10. [打包与分发](#10-打包与分发)
11. [实现步骤与里程碑](#11-实现步骤与里程碑)
12. [后续迭代规划](#12-后续迭代规划)
13. [风险与应对措施](#13-风险与应对措施)

## 1. 文档说明

### 1.1 文档目的

本文档是rf-win库的完整开发指南，定义了库的架构、功能、实现细节、测试策略和发布流程，为开发人员提供统一的开发标准，为使用者提供完整的使用参考。

### 1.2 术语定义

| 术语   | 定义                                |
| :--- | :-------------------------------- |
| RF   | Robot Framework，一款开源的自动化测试框架      |
| 后端   | 底层自动化实现引擎（pywinauto/UIAutomation） |
| 定位器  | 用于识别控件的标识（如ID、名称、XPath）           |
| 高DPI | 高分辨率显示模式（如125%/150%缩放比例）          |
| 原子操作 | 不可中断的最小操作单元（如单次鼠标点击）              |

### 1.3 修订记录

| 版本   | 日期         | 修订内容              | 修订人  |
| :--- | :--------- | :---------------- | :--- |
| V0.1 | 2025-12-10 | 初稿，确定核心框架         | 开发团队 |
| V1.0 | 2025-12-18 | 优化架构设计，补充细节，完善全流程 | 开发团队 |

## 2. 项目概述

### 2.1 项目背景

Windows桌面应用自动化是测试领域的核心需求，但现有Robot Framework库存在定位不稳定、兼容性差、易用性低、错误排查难等问题。rf-win库旨在封装pywinauto和UIAutomation，提供一套统一、稳定、易用的Windows桌面自动化关键字集。

### 2.2 核心目标

* **易用性**：符合RF自然语言风格，降低学习成本，提供图形化辅助工具。
* **性能**：通过缓存、批量操作等优化，提升自动化执行效率。
* **兼容性**：支持Win10/11、32/64位应用、主流UI框架（Win32/WPF/UWP/Qt）、高DPI缩放。
* **可维护性**：分层架构解耦，清晰的模块划分，完善的日志和错误处理。
* **扩展性**：支持自定义后端、关键字扩展，兼容RF生态其他库。

### 2.3 核心特性

* 应用全生命周期管理（启动/附加/关闭/状态检查）。
* 智能窗口定位与操作（模糊匹配、多条件组合、高DPI适配）。
* 丰富的控件交互（按钮/输入框/表格/树等，多定位策略）。
* 灵活的鼠标键盘操作（组合键、拖拽、慢速输入）。
* 完整的数据IO（文本/Excel/JSON/CSV）。
* 自动化截图（失败自动捕获、控件局部截图）。
* 智能等待与重试（避免硬编码sleep）。
* 完善的错误处理与日志（友好提示、上下文溯源）。

## 3. 整体架构设计

### 3.1 分层架构

rf-win采用**三层架构**设计，解耦底层依赖，提升扩展性和可维护性：

| 层级    | 职责               | 核心模块                                                |
| :---- | :--------------- | :-------------------------------------------------- |
| 业务模块层 | 暴露RF关键字，实现业务逻辑   | modules/（application/window/control等）               |
| 核心抽象层 | 定义抽象接口，统一行为规范    | core/（base\_application/base\_window等）              |
| 底层实现层 | 对接不同自动化后端，实现具体逻辑 | backend/（pywinauto\_backend/uiautomation\_backend等） |

### 3.2 目录结构

```
rf_win/
├── __init__.py                # 库入口，暴露RF关键字，加载全局配置
├── config/                    # 配置管理模块
│   ├── __init__.py
│   ├── global_config.py       # 全局配置（超时、重试、后端类型等）
│   └── local_config.py        # 局部配置（用例级覆盖，支持上下文）
├── core/                      # 核心抽象层
│   ├── __init__.py
│   ├── base_application.py    # 应用抽象类（定义应用操作接口）
│   ├── base_window.py         # 窗口抽象类（定义窗口操作接口）
│   ├── base_control.py        # 控件抽象类（定义控件操作接口）
│   └── base_operation.py      # 操作抽象类（鼠标/键盘/截图通用接口）
├── backend/                   # 底层实现层
│   ├── __init__.py
│   ├── pywinauto_backend.py   # pywinauto后端实现（Win32/UIA/DirectUI）
│   ├── uiautomation_backend.py # UIAutomation后端实现（WPF/UWP增强）
│   └── backend_factory.py     # 后端工厂（自动/手动切换后端）
├── modules/                   # 业务模块层
│   ├── __init__.py
│   ├── application.py         # 应用管理（继承BaseApplication）
│   ├── window.py              # 窗口管理（继承BaseWindow）
│   ├── control.py             # 控件交互（继承BaseControl）
│   ├── mouse_keyboard.py      # 鼠标键盘操作（继承BaseOperation）
│   ├── data_io.py             # 数据输入输出
│   ├── screenshot.py          # 截图功能
│   └── utils.py               # 基础工具函数
├── utils/                     # 通用工具模块
│   ├── __init__.py
│   ├── locator_helper.py      # 定位器解析/生成/图形化拾取工具
│   ├── wait_strategy.py       # 智能等待策略（存在/可交互/属性变化）
│   ├── cache_manager.py       # 窗口/控件缓存管理
│   ├── dpi_adapter.py         # 高DPI缩放适配
│   └── logger.py              # 分级日志工具（兼容RF日志系统）
├── tests/                     # 测试模块
│   ├── unit/                  # 单元测试（覆盖核心工具/抽象层）
│   ├── integration/           # 集成测试（模块间交互）
│   ├── e2e/                   # 端到端测试（真实应用场景）
│   └── mock/                  # 模拟对象（无真实应用时的测试）
├── docs/                      # 文档目录
│   ├── api_reference.md       # API参考（关键字列表+参数+示例）
│   ├── locator_guide.md       # 定位器使用指南
│   ├── compatibility.md       # 兼容性列表
│   ├── troubleshooting.md     # 排错指南
│   └── examples/              # 按应用类型分类的示例用例
└── tools/                     # 辅助工具
    ├── element_inspector.py   # 图形化元素定位器生成器
    └── log_analyzer.py        # 自动化日志分析工具
```

### 3.3 核心设计理念

#### 3.3.1 后端解耦

通过`backend_factory.py`实现后端的统一管理：

* 支持手动切换后端（如指定使用pywinauto的UIA后端）。
* 支持自动适配后端（根据应用类型选择最优后端，如Win32用pywinauto，WPF用UIAutomation）。
* 支持混合后端（同一用例中不同控件使用不同后端）。

#### 3.3.2 配置中心化

* 全局配置：默认超时10s、重试2次、截图路径./screenshots/等，可通过`global_config.py`修改。
* 局部配置：支持用例级覆盖（如`Set Global Variable ${RF_WIN_TIMEOUT} 20`）。
* 配置优先级：用例级变量 > 局部配置 > 全局配置 > 默认值。

#### 3.3.3 资源自动管理

* 通过上下文管理器（`with`语句）自动释放窗口/控件句柄，避免句柄泄漏。
* 进程监控：实时监控应用进程状态，异常退出时自动清理残留进程。
* 缓存过期：控件/窗口缓存自动过期（默认10s），避免缓存失效导致的定位错误。

## 4. 核心功能模块详细设计

### 4.1 应用管理模块（modules/application.py）

#### 4.1.1 核心关键字

| 关键字      | 功能描述                   | 参数示例                                       |
| :------- | :--------------------- | :----------------------------------------- |
| 启动应用     | 启动应用（支持参数、管理员权限、后台启动）  | `启动应用 路径:C:/app.exe 参数:--debug 管理员权限:True` |
| 附加到应用    | 附加到已运行应用（通过PID/进程名/标题） | `附加到应用 进程名:notepad.exe`                    |
| 检查应用运行状态 | 检查进程是否运行+主窗口是否响应       | `检查应用运行状态 应用对象:${app} → ${status}`         |
| 优雅关闭应用   | 发送关闭信号，超时后强制关闭         | `优雅关闭应用 应用对象:${app} 超时:10`                 |
| 强制关闭应用   | 直接终止进程                 | `强制关闭应用 应用对象:${app}`                       |
| 批量关闭应用   | 关闭多个应用                 | `批量关闭应用 应用列表:${app1},${app2}`              |

#### 4.1.2 实现细节

* 启动流程：解析参数 → 检查是否已运行 → 启动进程 → 等待主窗口就绪 → 返回应用对象。
* 附加流程：通过PID/进程名/标题查找进程 → 验证进程合法性 → 绑定窗口句柄 → 返回应用对象。
* 关闭流程：优雅关闭（发送WM\_CLOSE消息）→ 检查进程是否退出 → 超时则执行强制关闭（os.kill）。
* 状态检查：结合`psutil`检查进程状态 + 窗口句柄响应性检查（避免“假活”）。

### 4.2 窗口管理模块（modules/window\.py）

#### 4.2.1 核心关键字

| 关键字    | 功能描述                | 参数示例                                    |
| :----- | :------------------ | :-------------------------------------- |
| 定位窗口   | 多条件定位窗口（模糊/正则/组合条件） | `定位窗口 应用对象:${app} 标题包含:记事本 → ${window}` |
| 激活窗口   | 激活窗口并置于前台           | `激活窗口 窗口对象:${window}`                   |
| 调整窗口大小 | 调整窗口尺寸（支持高DPI适配）    | `调整窗口大小 窗口对象:${window} 宽度:800 高度:600`   |
| 获取窗口信息 | 获取窗口坐标/尺寸/句柄等       | `获取窗口信息 窗口对象:${window} → ${info}`       |
| 窗口置顶   | 设置窗口是否置顶            | `窗口置顶 窗口对象:${window} 置顶:True`           |
| 等待窗口消失 | 等待窗口关闭（支持超时）        | `等待窗口消失 窗口对象:${window} 超时:10`           |
| 列出应用窗口 | 列出应用所有窗口            | `列出应用窗口 应用对象:${app} → ${window_list}`   |

#### 4.2.2 实现细节

* 定位策略：支持精确匹配、模糊匹配（`title_contains`）、正则匹配（`title_regex`）、多条件组合（标题+类名）。
* 高DPI适配：通过`dpi_adapter.py`获取系统缩放比例，自动修正窗口坐标/尺寸。
* 智能等待：窗口操作前自动等待窗口可交互，支持配置超时和重试间隔。
* 句柄管理：自动维护窗口句柄映射，避免句柄失效导致的操作失败。

### 4.3 控件交互模块（modules/control.py）

#### 4.3.1 核心关键字

| 关键字       | 功能描述                      | 参数示例                                            |
| :-------- | :------------------------ | :---------------------------------------------- |
| 定位控件      | 多策略定位控件（ID/名称/XPath/链式定位） | `定位控件 窗口对象:${window} 定位器:id=btn_login → ${btn}` |
| 点击元素      | 点击控件（左键/右键/双击/指定坐标）       | `点击元素 控件对象:${btn} 点击类型:右键`                      |
| 输入文本      | 输入文本（清空/追加/慢速输入）          | `输入文本 控件对象:${edit} 文本:123456 慢速输入:True`         |
| 获取元素文本    | 获取控件显示文本                  | `获取元素文本 控件对象:${label} → ${text}`                |
| 选择下拉框选项   | 下拉框选择（按文本/索引）             | `选择下拉框选项 控件对象:${combo} 选项文本:选项1`                |
| 获取表格单元格文本 | 读取表格单元格内容                 | `获取表格单元格文本 控件对象:${table} 行:1 列:2 → ${text}`     |
| 展开树节点     | 展开树控件节点                   | `展开树节点 控件对象:${tree} 节点路径:父节点/子节点`               |
| 检查控件状态    | 检查控件是否可见/可交互/选中           | `检查控件状态 控件对象:${chk} 状态:选中 → ${status}`          |

#### 4.3.2 实现细节

* 定位器设计：
  * 极简语法：`id=xxx`（自动化ID）、`name=xxx`（名称）、`class=xxx`（类名）、`xpath=xxx`（UIA XPath）。
  * 链式定位：先定位父控件，再定位子控件（减少全局查找耗时）。
  * 自动识别：无需指定定位类型，库自动解析定位器格式。
* 智能等待：控件操作前等待控件“可交互”（而非仅“存在”），支持配置等待策略（存在/可交互/文本变化）。
* 重试机制：关键操作（点击/输入）默认重试1次，可通过配置调整次数和间隔。
* 控件类型适配：针对不同控件类型（按钮/输入框/表格/树）提供专属操作，封装底层差异。

### 4.4 鼠标键盘模块（modules/mouse\_keyboard.py）

#### 4.4.1 核心关键字

| 关键字   | 功能描述           | 参数示例                                     |
| :---- | :------------- | :--------------------------------------- |
| 鼠标点击  | 绝对/相对坐标点击      | `鼠标点击 坐标类型:相对 窗口对象:${window} X:100 Y:50` |
| 鼠标拖拽  | 鼠标拖拽（起点→终点）    | `鼠标拖拽 起点X:100 起点Y:50 终点X:200 终点Y:100`    |
| 按下组合键 | 按下组合键（如Ctrl+S） | `按下组合键 组合键:Ctrl+S`                       |
| 长按按键  | 长按指定按键（配置时长）   | `长按按键 按键:Shift 时长:2`                     |
| 滚轮滚动  | 鼠标滚轮滚动（上下/步数）  | `滚轮滚动 方向:向下 步数:5`                        |
| 鼠标悬停  | 鼠标悬停在指定位置      | `鼠标悬停 窗口对象:${window} X:100 Y:50`         |

#### 4.4.2 实现细节

* 坐标适配：支持绝对坐标（屏幕）和相对坐标（窗口/控件），自动适配高DPI。
* 组合键解析：自动拆分组合键（如`Ctrl+Alt+Del`），按顺序按下/释放。
* 原子操作：所有键盘/鼠标操作封装为原子操作，避免中途中断导致的状态异常。
* 慢速操作：支持模拟真人操作（如慢速点击、拖拽），适配响应慢的应用。

### 4.5 数据IO模块（modules/data\_io.py）

#### 4.5.1 核心关键字

| 关键字       | 功能描述               | 参数示例                                                        |
| :-------- | :----------------- | :---------------------------------------------------------- |
| 读取文本文件    | 读取文本文件（自动识别编码）     | `读取文本文件 路径:C:/test.txt → ${content}`                        |
| 写入文本文件    | 写入文本文件（支持追加/覆盖）    | `写入文本文件 路径:C:/test.txt 内容:hello 模式:追加`                      |
| 读取Excel文件 | 读取Excel指定sheet/单元格 | `读取Excel文件 路径:C:/test.xlsx Sheet:Sheet1 行:1 列:2 → ${value}` |
| 写入Excel文件 | 写入Excel指定位置        | `写入Excel文件 路径:C:/test.xlsx Sheet:Sheet1 行:1 列:2 内容:123`     |
| 读取JSON文件  | 读取JSON文件并解析为字典     | `读取JSON文件 路径:C:/test.json → ${data}`                        |
| 写入CSV文件   | 写入CSV文件（支持表头）      | `写入CSV文件 路径:C:/test.csv 数据:${data_list} 表头:姓名,年龄`           |

#### 4.4.2 实现细节

* 编码适配：自动识别文本文件编码（UTF-8/GBK/GB2312等），支持手动指定编码。
* 大文件处理：流式读写大文件（>100MB），避免内存溢出。
* Excel优化：批量读写Excel单元格，减少文件IO次数，支持公式计算结果读取。
* 格式校验：写入数据前校验格式（如JSON语法、CSV列数），提前抛出友好错误。

### 4.6 截图模块（modules/screenshot.py）

#### 4.6.1 核心关键字

| 关键字    | 功能描述          | 参数示例                                            |
| :----- | :------------ | :---------------------------------------------- |
| 捕获截图   | 捕获全屏/窗口/控件截图  | `捕获截图 类型:控件 目标对象:${btn} 保存路径:C:/screenshot.png` |
| 捕获失败截图 | 测试失败时自动捕获三级截图 | `捕获失败截图 测试名称:登录测试`                              |
| 延时截图   | 延时捕获截图        | `延时截图 延时:2 保存路径:C:/delay.png`                   |
| 批量捕获截图 | 批量捕获多个窗口/控件截图 | `批量捕获截图 目标列表:${window},${btn} 前缀:screenshot_`   |

#### 4.6.2 实现细节

* 集成RF：与RF的`Run Keyword And Capture Screenshot`无缝集成，失败时自动触发。
* 三级截图：失败时自动捕获“全屏+目标窗口+目标控件”截图，提升排错效率。
* 格式优化：支持PNG/JPG格式，可配置压缩质量，节省存储空间。
* 报告嵌入：截图Base64编码后嵌入RF测试报告，无需额外文件依赖。

### 4.7 工具模块（utils/）

#### 4.7.1 定位器助手（locator\_helper.py）

* 功能：图形化工具（Tkinter），实时显示鼠标指向的控件信息（ID/名称/类名/XPath），一键生成RF关键字。
* 核心接口：
  * `pick_element()`：启动拾取工具，返回控件信息。
  * `generate_locator()`：根据控件信息生成标准化定位器。

#### 4.7.2 智能等待（wait\_strategy.py）

* 支持的等待策略：
  * `wait_for_exists`：等待控件/窗口存在。
  * `wait_for_enabled`：等待控件可交互。
  * `wait_for_text_change`：等待文本变化。
  * `wait_for_attribute_change`：等待属性变化。
* 核心接口：`smart_wait(target, strategy, timeout, interval)`，自动重试直到满足条件或超时。

#### 4.7.3 缓存管理器（cache\_manager.py）

* 功能：缓存频繁访问的窗口/控件对象，减少重复查找耗时。
* 核心配置：缓存过期时间（默认10s）、最大缓存数量（默认100）。
* 核心接口：
  * `set_cache(key, value)`：设置缓存。
  * `get_cache(key)`：获取缓存（自动检查过期）。
  * `clear_cache()`：清空缓存。

#### 4.7.4 高DPI适配器（dpi\_adapter.py）

* 功能：自动检测系统DPI缩放比例，修正坐标/尺寸。
* 核心接口：
  * `get_dpi_scale()`：获取当前DPI缩放比例。
  * `adapt_coordinate(x, y)`：适配坐标到当前DPI。
  * `adapt_size(width, height)`：适配尺寸到当前DPI。

#### 4.7.5 日志工具（logger.py）

* 功能：分级日志（DEBUG/INFO/WARN/ERROR），兼容RF日志系统，包含上下文信息。
* 日志内容：操作类型、定位器、目标对象、耗时、异常信息（如有）。
* 输出方式：控制台、文件（默认./logs/rf\_win.log）。
* 核心接口：`log(level, message, **context)`，自动附加上下文（如应用名、窗口标题）。

## 5. 兼容性与适配策略

### 5.1 环境兼容

| 兼容项       | 支持范围                                   | 适配措施                                         |
| :-------- | :------------------------------------- | :------------------------------------------- |
| Python版本  | 3.8\~3.12                              | 代码兼容不同版本，CI测试覆盖所有版本                          |
| Windows版本 | Win10（1809+）、Win11、WinServer 2019/2022 | 适配不同系统的API差异，跳过系统专属功能                        |
| 应用架构      | 32/64位                                 | 自动检测应用架构，调用对应版本的后端接口                         |
| UI框架      | Win32、WPF、UWP、Qt、MFC、Delphi            | 后端自动适配（Win32用pywinauto，WPF/UWP用UIAutomation） |
| 高DPI缩放    | 100%/125%/150%/200%、Per-Monitor DPI    | dpi\_adapter自动修正坐标/尺寸                        |

### 5.2 多语言适配

* 控件定位：支持Unicode编码，兼容中文/日文/韩文等非英文界面。
* 日志/错误提示：默认中文/英文可切换（通过配置`language=zh-CN/en-US`）。
* 关键字：支持中英文双语关键字（如`点击元素`/`Click Element`）。

### 5.3 版本兼容策略

* 语义化版本：遵循`MAJOR.MINOR.PATCH`版本规则：
  * MAJOR：不兼容的API变更（如关键字重命名）。
  * MINOR：新增功能（向下兼容）。
  * PATCH：Bug修复（向下兼容）。
* 旧版本兼容层：新增功能时保留旧关键字，标记为`Deprecated`并提示替代方案，过渡期（3个MINOR版本）后移除。
* 版本检测：库内置版本检测接口，提示用户升级到最新版本（可选）。

## 6. 易用性设计

### 6.1 关键字设计规范

* 自然语言风格：关键字名称使用完整中文/英文，避免缩写（如`点击元素`而非`点元素`）。
* 参数清晰：参数名使用中文/英文全称（如`定位器`而非`loc`），必填参数在前，可选参数在后。
* 重载支持：同一关键字支持灵活传参（如`点击元素`可传定位器或控件对象）。
* 示例丰富：每个关键字的文档字符串包含“语法+参数说明+示例+预期结果”。

### 6.2 错误处理增强

#### 6.2.1 错误分类

| 错误类型 | 示例          | 解决方案提示                      |
| :--- | :---------- | :-------------------------- |
| 定位异常 | 控件未找到、窗口未找到 | 检查定位器是否正确；增加等待时间；确认应用是否正常运行 |
| 操作异常 | 控件不可交互、输入失败 | 检查控件状态；确认窗口是否激活；重试操作        |
| 系统异常 | 权限不足、句柄失效   | 以管理员权限运行；重新附加应用；检查系统资源      |

#### 6.2.2 错误信息格式

错误信息包含三层内容，便于快速定位问题：

```
【错误类型】定位异常
【操作上下文】操作：点击元素 | 定位器：name=登录 | 应用：notepad.exe | 窗口：记事本
【错误原因】控件未找到（超时10s）
【解决方案】1. 检查定位器是否正确；2. 确认记事本窗口是否打开；3. 增加等待时间（RF_WIN_TIMEOUT=20）
【底层异常】pywinauto.findwindows.ElementNotFoundError: ...
```

### 6.3 辅助工具

#### 6.3.1 元素定位器生成器

* 功能：图形化工具，实时显示鼠标指向的控件信息，一键生成RF关键字。
* 使用流程：
  1. 启动工具：`python -m rf_win.tools.element_inspector`。
  2. 鼠标移动到目标控件，按下`F1`拾取控件信息。
  3. 工具自动生成关键字（如`定位控件 定位器:id=btn_login`）。
  4. 复制关键字到RF用例中使用。

#### 6.3.2 IDE插件

* VSCode/PyCharm插件：提供关键字语法提示、定位器校验、日志高亮。
* 核心功能：
  * 关键字自动补全（如输入`点击`，提示`点击元素`/`点击菜单项`）。
  * 定位器语法校验（如检测XPath语法错误）。
  * 日志高亮（ERROR级日志标红，INFO级标蓝）。

#### 6.3.3 示例工程

提供不同应用类型的完整示例用例，覆盖常见场景：

* 记事本：文本输入/保存/关闭。
* 计算器：按钮点击/结果验证。
* WPF示例程序：表格/树控件操作。
* UWP应用：菜单/下拉框操作。

## 7. 性能与稳定性优化

### 7.1 性能优化

#### 7.1.1 缓存优化

* 缓存频繁访问的窗口/控件对象，减少重复遍历控件树（性能提升30%+）。
* 缓存过期策略：自动过期（默认10s）、手动清空、操作失败时清空对应缓存。

#### 7.1.2 批量操作

* 支持批量定位/操作控件（如`批量点击控件 定位器列表:${loc1},${loc2}`），减少循环开销。
* Excel批量读写：一次性读写多个单元格，减少文件IO次数。

#### 7.1.3 异步操作

* 可选异步执行非阻塞操作（如“等待窗口”），提升并发场景效率。
* 使用`asyncio`封装异步操作，兼容RF的同步执行模型。

### 7.2 稳定性优化

#### 7.2.1 超时全覆盖

* 所有IO/查找/操作都配置超时（默认10s，可通过`RF_WIN_TIMEOUT`自定义），避免无限等待。
* 超时策略：渐进式超时（初始5s，失败后重试+延长超时）。

#### 7.2.2 重试机制

* 关键操作（点击、输入、定位）支持自动重试（默认1次，可通过`RF_WIN_RETRY`配置次数）。
* 重试间隔：指数退避（1s→2s→4s），避免短时间内重复失败。

#### 7.2.3 资源隔离

* 操作目标应用时，过滤系统关键进程（如explorer.exe、svchost.exe），避免误操作。
* 进程隔离：每个应用对象绑定独立的进程ID，避免跨应用操作。

#### 7.2.4 原子操作与回滚

* 控件操作封装为原子操作，失败时回滚状态（如输入文本失败时清空输入框）。
* 句柄管理：自动检测句柄失效，重新获取句柄后重试操作。

## 8. 测试体系

### 8.1 测试分层

| 测试类型  | 测试对象               | 测试工具            | 覆盖率目标 |
| :---- | :----------------- | :-------------- | :---- |
| 单元测试  | 核心工具、抽象层、后端实现      | pytest          | ≥80%  |
| 集成测试  | 模块间交互（应用→窗口→控件）    | Robot Framework | ≥70%  |
| 端到端测试 | 真实应用场景             | Robot Framework | ≥60%  |
| 兼容性测试 | 不同Python/Windows版本 | GitHub Actions  | 100%  |

### 8.2 测试用例设计

#### 8.2.1 单元测试

* 覆盖核心工具（缓存、DPI适配、等待策略）。
* 覆盖抽象层接口（应用/窗口/控件抽象类）。
* 覆盖后端实现（pywinauto/UIAutomation接口）。
* 使用mock对象模拟底层依赖，避免依赖真实应用。

#### 8.2.2 集成测试

* 测试模块间交互：启动应用→定位窗口→定位控件→点击控件→验证结果。
* 测试异常场景：定位不存在的控件、操作不可交互的控件、超时场景。

#### 8.2.3 端到端测试

* 基于真实应用（记事本、计算器、WPF示例程序）。
* 覆盖核心场景：
  * 记事本：启动→输入文本→保存→关闭→验证文件内容。
  * 计算器：点击数字→点击运算符→点击等号→验证结果。
  * WPF程序：表格单元格读写、树节点展开/选中。

#### 8.2.4 兼容性测试

* 测试环境矩阵：
  | Python版本 | Windows版本      | 应用架构 | DPI缩放 |
  | :------- | :------------- | :--- | :---- |
  | 3.8      | Win10 64位      | 32位  | 100%  |
  | 3.9      | Win10 64位      | 64位  | 125%  |
  | 3.10     | Win11 64位      | 32位  | 150%  |
  | 3.11     | Win11 64位      | 64位  | 200%  |
  | 3.12     | WinServer 2022 | 64位  | 100%  |

### 8.3 CI/CD流水线

通过GitHub Actions实现自动化测试与发布：

#### 8.3.1 触发条件

* 代码提交/PR（运行单元测试+集成测试）。
* 定时任务（每日，运行兼容性测试）。
* 发布标签（运行全量测试+打包发布）。

#### 8.3.2 流水线步骤

```
1. 环境准备：安装Python、依赖包、测试应用。
2. 代码规范检查：flake8（语法）、black（格式）、mypy（类型）。
3. 单元测试：pytest --cov=rf_win（生成覆盖率报告）。
4. 集成测试：robot tests/integration（生成RF报告）。
5. 兼容性测试：在不同环境矩阵中运行端到端测试。
6. 打包：python -m build（生成wheel/sdist）。
7. 发布：符合版本规则时，自动发布到PyPI。
8. 报告上传：将测试报告/覆盖率报告上传到GitHub Artifacts。
```

## 9. 文档与生态建设

### 9.1 文档体系

| 文档类型  | 内容                   | 受众      |
| :---- | :------------------- | :------ |
| 快速开始  | 5分钟上手教程（安装→第一个用例→运行） | 新手用户    |
| API参考 | 所有关键字的参数、返回值、示例、异常   | 开发/测试人员 |
| 定位器指南 | 不同控件类型的定位策略、最佳实践     | 测试人员    |
| 兼容性列表 | 支持的应用/系统/Python版本    | 运维/测试人员 |
| 排错指南  | 常见错误原因与解决方案          | 所有用户    |
| 进阶教程  | 自定义后端、配置管理、性能优化      | 高级用户    |

### 9.2 生态整合

#### 9.2.1 RF内置库集成

* 复用BuiltIn库的变量、关键字（如`Set Global Variable`）。
* 复用Screenshot库的截图机制，实现失败自动截图。
* 复用Collections库的集合操作，处理控件列表/表格数据。

#### 9.2.2 第三方库兼容

* DataDriver：支持Excel/CSV数据源的参数化测试。
* RobotFramework-DatabaseLibrary：支持数据库数据与桌面应用交互。
* RobotFramework-AppiumLibrary：支持桌面+移动端混合自动化。

#### 9.2.3 报告增强

* 截图嵌入：将截图Base64编码后嵌入RF HTML报告。
* 操作耗时统计：在报告中显示每个关键字的执行耗时。
* 控件信息展示：在报告中显示控件定位器、属性等上下文信息。

### 9.3 社区支持

* GitHub Issues：提供标准化模板（问题类型、环境、复现步骤）。
* 讨论区：Discord/Gitee讨论区，定期解答常见问题。
* 版本更新：发布日志包含新功能、Bug修复、兼容性变更。

## 10. 打包与分发

### 10.1 打包配置

* 遵循PEP 621标准，使用`pyproject.toml`+`setup.cfg`配置打包信息。
* 核心配置：
  ```toml
  [project]
  name = "rf-win"
  version = "1.0.0"
  authors = [{"name": "rf-win开发团队", "email": "dev@rf-win.com"}]
  description = "Windows桌面自动化Robot Framework库"
  long_description = file: "README.md"
  long_description_content_type = "text/markdown"
  classifiers = [
    "Framework :: Robot Framework",
    "Framework :: Robot Framework :: Library",
    "Operating System :: Microsoft :: Windows",
    "Programming Language :: Python :: 3.8",
    "Programming Language :: Python :: 3.9",
    "Programming Language :: Python :: 3.10",
    "Programming Language :: Python :: 3.11",
    "Programming Language :: Python :: 3.12",
  ]
  requires-python = ">=3.8"
  dependencies = [
    "pywinauto>=0.6.8",
    "uiautomation>=2.0.10",
    "openpyxl>=3.1.2",
    "Pillow>=10.0.0",
    "psutil>=5.9.0",
    "pyyaml>=6.0",
  ]
  [project.optional-dependencies]
  dev = [
    "pytest>=7.0.0",
    "pytest-cov>=4.0.0",
    "robotframework>=6.0.0",
    "build>=0.10.0",
    "twine>=4.0.0",
  ]
  ```

### 10.2 依赖管理

* 核心依赖：确保版本兼容性，避免依赖冲突。
* 可选依赖：开发/测试依赖放在`optional-dependencies`中，不影响生产环境。
* 依赖锁定：提供`requirements.txt`（生产）和`requirements-dev.txt`（开发），锁定版本号。

### 10.3 分发渠道

* PyPI：发布正式版本，支持`pip install rf-win`。
* GitHub Releases：发布预发布版本、源码包、示例工程。
* 国内镜像：同步到阿里云/清华PyPI镜像，方便国内用户安装。

### 10.4 安装说明

* 基础安装：`pip install rf-win`。
* 完整安装（含开发工具）：`pip install rf-win[dev]`。
* 离线安装：提供wheel包，支持离线环境安装。

## 11. 实现步骤与里程碑

| 阶段             | 周期   | 核心任务                            | 交付物                             | 验收标准                    |
| :------------- | :--- | :------------------------------ | :------------------------------ | :---------------------- |
| 1. 基础架构        | 1周   | 搭建分层架构、配置管理、核心抽象层               | 项目骨架、配置模块、抽象类                   | 架构符合设计，配置可正常加载/覆盖       |
| 2. 后端适配        | 1周   | 实现pywinauto/UIAutomation后端、工厂模式 | 后端模块、切换逻辑                       | 可切换后端，基础接口正常工作          |
| 3. 核心功能（应用/窗口） | 1.5周 | 应用启动/关闭、窗口定位/操作、高DPI适配          | application/window模块、基础关键字      | 应用/窗口操作稳定，高DPI适配正确      |
| 4. 核心功能（控件/键鼠） | 2周   | 控件定位/交互、鼠标键盘操作、缓存机制             | control/mouse\_keyboard模块、核心关键字 | 控件定位成功率≥99%，操作无偏移       |
| 5. 辅助功能        | 1周   | 数据IO、截图、工具模块（定位器/等待）            | data\_io/screenshot/utils模块     | 数据读写正确，截图功能正常，定位器工具可用   |
| 6. 错误处理&日志     | 0.5周 | 异常分类、友好提示、日志体系                  | 错误处理模块、日志工具                     | 错误信息清晰，日志包含完整上下文        |
| 7. 测试体系        | 1.5周 | 单元测试、集成测试、E2E测试                 | 测试用例、覆盖率报告                      | 单元测试覆盖率≥80%，E2E测试覆盖核心场景 |
| 8. 文档&工具       | 1周   | 编写文档、开发定位器工具、示例工程               | 完整文档、定位器工具、示例代码                 | 文档覆盖所有功能，示例可直接运行        |
| 9. 打包\&CI/CD   | 0.5周 | 打包配置、CI流水线、PyPI发布               | 安装包、CI配置、PyPI发布                 | 可通过pip安装，CI流水线自动运行      |
| 10. 测试&优化      | 1周   | 兼容性测试、性能优化、Bug修复                | 优化后的库、测试报告                      | 兼容所有目标环境，性能提升≥30%       |

## 12. 后续迭代规划

| 版本   | 核心迭代内容                               | 预计周期      |
| :--- | :----------------------------------- | :-------- |
| V1.0 | 核心功能（应用/窗口/控件/键鼠/截图/数据IO）+ 基础文档 + 测试 | 已规划       |
| V1.1 | 性能优化（缓存/批量操作）+ 定位器工具 + 多语言支持         | V1.0发布后2周 |
| V1.2 | 扩展控件支持（表格/树/菜单）+ 异步操作 + 报告增强         | V1.1发布后3周 |
| V1.3 | 可视化编辑器（拖拽式编写用例）+ 更多辅助工具              | V1.2发布后4周 |
| V2.0 | 自定义关键字扩展 + 云测集成 + 分布式执行              | V1.3发布后6周 |

## 13. 风险与应对措施

| 风险点                             | 可能性 | 影响          | 应对措施                                    |
| :------------------------------ | :-- | :---------- | :-------------------------------------- |
| 不同应用的控件定位不稳定                    | 高   | 用例执行失败      | 1. 增加定位器容错（模糊匹配）；2. 智能重试；3. 提供定位器优化指南   |
| 高DPI下坐标偏移                       | 中   | 点击/拖拽位置错误   | 1. 自动检测DPI缩放；2. 修正坐标/尺寸；3. 提供手动适配接口     |
| 后端API变更（pywinauto/UIAutomation） | 中   | 库功能失效       | 1. 锁定依赖版本；2. 适配新版本API；3. 提供旧版本兼容层       |
| 系统权限限制导致操作失败                    | 中   | 应用启动/控件操作失败 | 1. 提示以管理员权限运行；2. 自动检测权限并提权；3. 提供权限检查关键字 |
| 大文件IO导致内存溢出                     | 低   | 程序崩溃        | 1. 流式读写大文件；2. 内存监控；3. 分块处理数据            |
| 跨版本Windows API差异                | 低   | 部分功能失效      | 1. 适配不同系统API；2. 跳过系统专属功能；3. 提供兼容模式      |

## 附录：核心关键字列表

### 应用管理

* 启动应用
* 附加到应用
* 检查应用运行状态
* 优雅关闭应用
* 强制关闭应用
* 批量关闭应用

### 窗口管理

* 定位窗口
* 激活窗口
* 调整窗口大小
* 获取窗口信息
* 窗口置顶
* 隐藏窗口
* 等待窗口消失
* 列出应用窗口

### 控件交互

* 定位控件
* 点击元素
* 输入文本
* 获取元素文本
* 选择下拉框选项
* 获取表格单元格文本
* 展开树节点
* 点击菜单项
* 检查控件状态

### 鼠标键盘

* 鼠标点击
* 鼠标拖拽
* 按下组合键
* 长按按键
* 滚轮滚动
* 鼠标悬停

### 数据IO

* 读取文本文件
* 写入文本文件
* 读取Excel文件
* 写入Excel文件
* 读取JSON文件
* 写入JSON文件
* 读取CSV文件
* 写入CSV文件

### 截图

* 捕获截图
* 捕获失败截图
* 延时截图
* 批量捕获截图

### 工具类

* 设置全局配置
* 智能等待
* 清空缓存
* 生成定位器
* 检查DPI缩放

